{% extends "partials/base.html" %}
{% load static %}

{% block content %}
<style>
    .checkout-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }

    .checkout-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e5e7eb;
    }

    .checkout-header h1 {
        font-size: 2rem;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0;
    }

    .checkout-content {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
        align-items: start;
    }

    .checkout-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e5e7eb;
    }

    .address-selection {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .address-option {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .address-option:hover {
        border-color: #2563eb;
        background: #f0f7ff;
    }

    .address-option.selected {
        border-color: #2563eb;
        background: #eff6ff;
    }

    .address-option input[type="radio"] {
        margin: 0;
        cursor: pointer;
    }

    .address-text {
        flex: 1;
        color: #374151;
        font-size: 0.95rem;
    }

    .address-badge {
        background: #10b981;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .btn-add-address {
        padding: 0.75rem 1rem;
        background: transparent;
        border: 2px dashed #cbd5e0;
        color: #667eea;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
        text-align: center;
    }

    .btn-add-address:hover {
        border-color: #667eea;
        background: #f0f7ff;
    }

    .order-summary {
        position: sticky;
        top: 20px;
    }

    .order-items {
        margin-bottom: 1rem;
    }

    .order-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .order-item:last-child {
        border-bottom: none;
    }

    .order-item-name {
        color: #374151;
        font-size: 0.9rem;
    }

    .order-item-qty {
        color: #6b7280;
        font-size: 0.85rem;
    }

    .order-item-price {
        color: #1a1a1a;
        font-weight: 600;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
        color: #4b5563;
    }

    .summary-row.total {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a1a1a;
        padding-top: 1rem;
        margin-top: 1rem;
        border-top: 2px solid #e5e7eb;
    }

    .payment-section {
        margin-top: 1.5rem;
    }

    #paypal-button-container {
        margin-top: 1rem;
    }

    .btn-place-order {
        width: 100%;
        padding: 1rem;
        background: #1a1a1a;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .btn-place-order:hover {
        background: #2d2d2d;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-place-order:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    @media (max-width: 968px) {
        .checkout-content {
            grid-template-columns: 1fr;
        }

        .order-summary {
            position: static;
        }
    }
</style>

<div class="checkout-container">
    <div class="checkout-header">
        <h1>Checkout</h1>
    </div>

    <form id="checkout-form" method="POST">
        {% csrf_token %}
        <div class="checkout-content">
            <div class="checkout-main">
                <!-- Address Selection -->
                <div class="checkout-section">
                    <h2 class="section-title">Shipping Address</h2>
                    <div class="address-selection">
                        {% if addresses %}
                            {% for addr in addresses %}
                            <label class="address-option {% if addr.default or forloop.first %}selected{% endif %}">
                                <input type="radio" name="address" value="{{ addr.id }}" {% if addr.default or forloop.first %}checked{% endif %}>
                                <span class="address-text">{{ addr.adress }}</span>
                                {% if addr.default %}
                                <span class="address-badge">Default</span>
                                {% endif %}
                            </label>
                            {% endfor %}
                        {% else %}
                            <p style="color: #6b7280; margin-bottom: 1rem;">No addresses found. Please add one in your profile.</p>
                        {% endif %}
                        <a href="{% url 'profile' %}" class="btn-add-address">+ Add New Address</a>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="order-summary">
                <div class="checkout-section">
                    <h2 class="section-title">Order Summary</h2>
                    <div class="order-items">
                        {% for item in cart_items %}
                        <div class="order-item">
                            <div>
                                <div class="order-item-name">{{ item.product.title }}</div>
                                <div class="order-item-qty">Qty: {{ item.quantity }}</div>
                            </div>
                            <div class="order-item-price">${{ item.subtotal|floatformat:2 }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span>${{ cart_total_amount|floatformat:2 }}</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping</span>
                        <span>Free</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="total-amount">${{ cart_total_amount|floatformat:2 }}</span>
                    </div>

                    <div class="payment-section">
                        <h3 class="section-title" style="font-size: 1rem; margin-bottom: 0.75rem;">Payment Method</h3>
                        <div id="paypal-button-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- PayPal SDK -->
<!-- IMPORTANT: Replace YOUR_PAYPAL_CLIENT_ID with your actual PayPal Client ID from PayPal Developer Dashboard -->
<script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=USD"></script>
<script>
    const totalAmount = {{ cart_total_amount|floatformat:2 }};
    const cartItems = [
        {% for item in cart_items %}
        {
            name: "{{ item.product.title|escapejs }}",
            quantity: {{ item.quantity }},
            unit_amount: {
                currency_code: "USD",
                value: "{{ item.price|floatformat:2 }}"
            }
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        currency_code: "USD",
                        value: totalAmount.toFixed(2),
                        breakdown: {
                            item_total: {
                                currency_code: "USD",
                                value: totalAmount.toFixed(2)
                            }
                        }
                    },
                    items: cartItems
                }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                // Get selected address
                const addressId = document.querySelector('input[name="address"]:checked')?.value;
                
                // Submit order to server
                fetch('/execute-payment/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: 'payment_id=' + data.orderID + '&address_id=' + addressId
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/profile/';
                    } else {
                        alert('Order processing failed. Please try again.');
                    }
                });
            });
        },
        onError: function(err) {
            console.error('PayPal error:', err);
            alert('Payment failed. Please try again.');
        }
    }).render('#paypal-button-container');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}